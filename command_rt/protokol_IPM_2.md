# Протокол обмена данными информационного каркаса ИПМ-2
rev. 0.5 от 11.04.20024
## Назначение и технические требования
### Назначение
Протокол обмена данными предназначен для выдачи информации измерительным каркасом ИПМ-2.
### Технические требования
Для обеспечения работы измерительного каркаса ИПМ-2 по протоколу обмена данными,
внешнее  устройство  должно  обладать  возможностью  подключения  стандартными  линиями
последовательной передачи данных RS232, RS422 или ethernet по протоколу UDP.  
Программное обеспечение должно поддерживать протоколы последовательной передачи
данных.
## Описание протокола обмена данными измерительного каркаса ИПМ-2

### Общие сведения
#### RS232/422
Настройка последовательного порта передачи данных.

|Параметр | Значение|
|:-|:-:|
|Скорость обмена [бит/с] | 460800|
|Бит данных | 8|
|Стоп бит | 1|
|Контроль четности | нет|

Контрольная сумма - это дополнение до 0 суммы байт + 55h. <br>
Контрольная сумма + сумма байт + 55h = 0 

Коды ошибок:

|Код|Описание|
|:-:|:-|
|1|Несовпадение контрольной суммы|
|2|Команда не распознана|

Протокол обмена обеспечивает работу ИПМ-2 в режимах "запрос ответ" и "периодическая передача данных".

#### Ethernet по протоколу UDP
Для обмена с каркасом нужно открыть 2 соединения.
1. Связывается с каркасом по адресу (IP каркаса):8000 и выдает команды на этот адрес.
2. Слушает свой порт 8001 и принимает данные и ответы на команды.   
#### Режим "запрос ответ"
- посылаем команду размером 8 байт и данные команды (данных может не быть)
- принимаем ответ размером 8 байт и данные ответа (данных может не быть).
Ответ на команду содежит код команды, код ошибки и другую информацию, в зависимомсти от команды.
#### Режим "периодическая передача данных"
Переводим каркас в режим "периодическая передача данных" (плосылаем коману 7) 
в ответ принимаем первую посылку периодических данных, 
которая ответа на команду НЕ содержит. Ответ приходит во второй посылке, которая прийдет через 100 мс.
Далее с периодом 100 мс будут приходить пакеты данных следующего формата:
1. заголовок ответа с кодом команды FFh и размером всего пакета;
2. Заголок структур данных;
3. Данные
4. Заголок структур данных;
5. Данные
<br>......
<br> В этом режиме можно посылать команды. Ответы будут приходить в общем пакете данных в формате:
<br>......
- Заголок структур данных;
- Ответ на команду
<br>......
#### Коды типов модулей
|Код|Название модуля|Тип сигнала|Диапазон|
|:-:|:-|
|20|МПА_01-2|ДПЗ|5 мкА
|25|МПА_02-1|ТС|150 Ом
|35|МПА_03-1|ТП|20 мВ
|40|МПА_04-1|НС|5 мА
|41|МПА_05-1|НС|5 В
|42|МПА_06-1|НС|20 мВ
|100|МПД_01-1|Дискретный "сухой контакт"|
|110|МПД_02-1|Дискретный "потенциальный"|
|120|МПР_01-1|Релейный|

#### Формула для расчета электрических величин аналоговых модулей 
A=(B - 8000) / 25000 * C <br> 
где 
+ A - электрическая величина; 
+ B - код АЦП; 
+ C - диапазон модуля.

#### Формула для расчета сопротивления контактов в МПД01-1 (сухоконтактный) 
U - U0 = Rx / (Rx + R) * Umax <br> 
из этой формулы вычисляем Rx.<br>
Компенсация последовательного защитного диода <br>
 Rx = Rx + Rx * Rx * 0.0055 <br>
где 
+ U - полученные дискреты;
+ U0 - дискреты при коротком замыкании = 5;
+ Umax - дискреты в разомкнутом состоянии = 906;
+ R - сопротивление резистор в схеме 1.55 кОм;
+ Rx - искомое сопротивление в кОм.

#### Формула для расчета напряжения в МПД02-1 (потенциальный)
U = (A - 12) * 0.05  <br>
где 
+ U - напряжение в [B]; 
+ A - код АЦП; 
+ 12 - средние дискреты при 0 В;
+ 0.05 - наклон.

#### Формула для расчета времени инициатив в МПД01-1, МПД02-1
T = A - (B - C) * 1.111  <br>
где 
+ A - время приема данных [мс]; 
+ B - "Текущее время" из пакета данных [дискреты]; 
+ C - "Время инициативы" из пакета данных [дискреты];
+ T - абсолютное время инициативы.

#### Номер модуля
Номер модуля состоит из 2 байт. 0..9 бит - номер, 10..15 бит - год изготовления модуля минус 2000    

### Формат команды
Команда состоит из заголовка команды (8 байт) и данных, которые следуют за командой.
Контрольная сумма данных располагается:
- в данных;
- в информационном поле 3
<br><br> 
Таблица 1. Заголовок команды
  
|Смещение,<br>байт|Размер поля,<br>байт|Значение|Описание|
|:-:|:-:|:-:|:-|
|0 |1|68h|Префикс|
|+1|1|0...60|Размер данных команды|
|+2|1|1...9|Код команды|
|+3|1|0...255|Параметр команды|
|+4|1|0...255|Информационное поле 1|
|+5|1|0...255|Информационное поле 2|
|+6|1|0...255|Информационное поле 3|
|+7|1|00h...FFh|Контрольная сумма|

### Формат ответа

Ответ состоит из заголовка ответа (8 байт) и данных, которые следуют за заголовком. 
<br><br>
Таблица 2. Заголовок ответа.

|Смещение,<br>байт|Размер поля,<br>байт|Значение|Описание|
|:-:|:-:|:-:|:-|
|0 |1|53h|Префикс|
|+1|2|0...FFFFh|Размер данных ответа: 1 - младший байт, 2 старший байт|
|+3|1|1...9|Код команды|
|+4|1|0...255|Код ошибки|
|+5|1|0...255|Информационное поле 1|
|+6|1|0...255|Информационное поле 2|
|+7|1|00h...FFh|Контрольная сумма|

Контрольная сумма данных располагается:
- в данных;
- в информационном поле 2

### Формат мультиструктурных данных

При переодической передаче данных данные состоят из нескольких структут. Каждая структура начинается с 
8 байтного заголовка:
<br><br>
Таблица 3. Заголовок структур данных
  
|Смещение,<br>байт|Размер поля,<br>байт|Значение|Описание|
|:-:|:-:|:-:|:-|
|0|1|0...60|Размер структуры|
|+1|1|0...255|Код ошибки|
|+2|1|0...255|Тип структуры|
|+3|1|0...255|Информационное поле 1|
|+4|1|0...255|Информационное поле 2|
|+5|1|0...255|Информационное поле 3|
|+6|1|00h...FFh|Контрольная сумма структуры|
|+7|1|00h...FFh|Контрольная сумма|

## Описание команд

### Установка режима работы каркаса ИПМ-2 (код команды 7)
Формат команды (смотри Таблицу 1)
 
|Значение|Описание|
|:-:|:-|
|68h|Префикс|
|0|Размер данных команды|
|7|Код команды|
||Параметр команды|
|1|Периодическая передача данных|
|2|Однократная передача данных|
|0...255|Информационное поле 1|
|0...255|Информационное поле 2|
|0...255|Информационное поле 3|
|00h...FFh|Контрольная сумма|

Формат ответа (смотри Таблицу 2)

|Значение|Описание|
|:-:|:-|
|53h|Префикс|
|0|Размер данных ответа|
|7|Код команды|
|0...255|Код ошибки|
||Информационное поле 1|
|1,2|параметр команды|
|0...255|Информационное поле 2|
|00h...FFh|Контрольная сумма|

### Запись EEPROM (код команды 8)
Команда реализована только для обмена по последовательным портам.
Формат команды (смотри Таблицу 1). Размер EEPROM - 128 КБайт 
 
|Значение|Описание|
|:-:|:-|
|68h|Префикс|
|112|Размер данных команды|
|8|Код команды|
||Параметр команды|
|0|Запись|
|0...255|Информационное поле 1|
|0...255|Информационное поле 2|
|0...255|Информационное поле 3|
|00h...FFh|Контрольная сумма|

За командой следуют 112 байт данных.  

|Смещение,<br>байт|Размер поля,<br>байт|Значение|Описание|
|:-:|:-:|:-:|:-|
|0|1|1...255|Номер стойки|
|+1|1|1...5|Номер каркаса|
|+2|1|1, 2|Номер магистрали|
|+3|6|0...255|MAC адрес|
|+9|4|0...255|IP адрес|
|+13|4|0...255|IP адрес шлюза|
|+17|4|0...255|маска подсети|
|+21|5 Х 18|0...255|таблица заполнения для каждого из 4 каркасов (нулевой номер каркаса резерв)|
|+111|1|0...255|Контрольная сумма|

Формат ответа записи (смотри Таблицу 2)

|Значение|Описание|
|:-:|:-|
|53h|Префикс|
|0|Размер данных ответа|
|8|Код команды|
|0...255|Код ошибки|
||Информационное поле 1|
|0|параметр команды|
|0...255|Информационное поле 2|
|00h...FFh|Контрольная сумма|


### Чтение EEPROM (код команды 8)
Команда реализована только для обмена по последовательным портам.
Формат команды (смотри Таблицу 1)
 
|Значение|Описание|
|:-:|:-|
|68h|Префикс|
|0|Размер данных команды|
|8|Код команды|
||Параметр команды|
|1|Чтение|
|0...255|Информационное поле 1|
|0...255|Информационное поле 2|
|0...255|Информационное поле 3|
|00h...FFh|Контрольная сумма|

Формат ответа записи (смотри Таблицу 2)

|Значение|Описание|
|:-:|:-|
|53h|Префикс|
|112|Размер данных ответа|
|8|Код команды|
|0...255|Код ошибки|
||Информационное поле 1|
|1|параметр команды|
|0...255|Информационное поле 2|
|00h...FFh|Контрольная сумма|

За ответом следуют 112 байт данных. Формат смотри "Запись EEPROM". 

### Управление модулями 

Формат команды (смотри Таблицу 1)

|Значение|Описание|
|:-:|:-|
|68h|Префикс|
|0|Размер данных команды|
||Код команды|
|10|Выключение корректирующих коэффициентов|
|11|Читать EEPROM|
|12|Неисправности|
|13|Режима "тест"|
|14|Запрет контролей|
|15|Контроль 1|
|16|Контроль 2|
|17|Измерение Фона|
||Параметр команды|
|0|Выключить|
|1|Включить|
||Информационное поле 1|
|1...18|Номер места модуля|
|0...255|Информационное поле 2|
|0...255|Информационное поле 3|
|00h...FFh|Контрольная сумма|

Формат ответа (смотри Таблицу 2)

|Значение|Описание|
|:-:|:-|
|53h|Префикс|
|0|Размер данных ответа|
|10...17|Код команды|
|0...255|Код ошибки|
||Информационное поле 1|
|0,1|параметр команды|
|0...255|Информационное поле 2|
|00h...FFh|Контрольная сумма|

### Управление маской инициативных сигналов для модуля МПД_01-1 (код команды - 18) 

МПД_01-1 - модуль приема дискретных сигналов. Инициативными назначаются сигналы,
изменение которых необходимо привязать ко времени. Маска состоит из 8 бит (1 байт): 
- 0 бит соответствует 1 каналу измерения; 
- ...; 
- 7 бит соответствует 8 каналу измерения.
<br> 
<br> 
Биты принимают следующие значения:
- 0 - не инициативный канал измерения;
- 1 - инициативный канал измерения. 

Формат команды (смотри Таблицу 1)

|Значение|Описание|
|:-:|:-|
|68h|Префикс|
|0|Размер данных команды|
||Код команды|
|18|Установка маски инициативных сигналов|
||Параметр команды|
|0...FFh|Маска инициативных каналов|
||Информационное поле 1|
|1...18|Номер места модуля|
|0...255|Информационное поле 2|
|0...255|Информационное поле 3|
|00h...FFh|Контрольная сумма|

Формат ответа (смотри Таблицу 2)

|Значение|Описание|
|:-:|:-|
|53h|Префикс|
|0|Размер данных ответа|
|18|Код команды|
|0...255|Код ошибки|
||Информационное поле 1|
|0...FFh|параметр команды|
|0...255|Информационное поле 2|
|00h...FFh|Контрольная сумма|

### Управление сотояним реле для модуля МПР_01-1 (код команды - 19) 

МПР_01-1 - модуль выдачи релейных сигналов. В параметре команды передается маска состояня реле.
 Маска состоит из 8 бит (1 байт): 
- 0 бит соответствует 1 реле; 
- 1 бит соответствует 2 реле; 
- 2 бит соответствует 3 реле; 
- 3 бит соответствует 4 реле.
<br> 
<br> 
Биты принимают следующие значения:
- 0 - реле выключено;
- 1 - реле включено. 

Формат команды (смотри Таблицу 1)

|Значение|Описание|
|:-:|:-|
|68h|Префикс|
|0|Размер данных команды|
||Код команды|
|19|Управление состоянием реле|
||Параметр команды|
|0...0Fh|Маска состояния реле|
||Информационное поле 1|
|1...18|Номер места модуля|
|0...255|Информационное поле 2|
|0...255|Информационное поле 3|
|00h...FFh|Контрольная сумма|

Формат ответа (смотри Таблицу 2)

|Значение|Описание|
|:-:|:-|
|53h|Префикс|
|0|Размер данных ответа|
|19|Код команды|
|0...255|Код ошибки|
||Информационное поле 1|
|0...0Fh|параметр команды|
|0...255|Информационное поле 2|
|00h...FFh|Контрольная сумма|

### Периодическая передача данных
Каркас передает мультиструктурные данные по всем модулям с периодом 100 мс 
без запроса. При передаче команды в этом режиме ответ включается в общий пакет данных.
При периодической передаче данных пакет начинается с заголовока ответа 
(смотри Таблицу 2), потом идут мультиструктурные данные модулей и ответов на команды. 

Заголовок ответа:

|Значение|Описание|
|:-:|:-|
|53h|Префикс|
|0...FFFFh|Размер данных ответа|
|FFh|Код команды|
|0...255|Код ошибки|
|0...255|Информационное поле 1|
|0...255|Информационное поле 2|
|00h...FFh|Контрольная сумма|

Заголовок данных (смотри Таблицу 3):

|Значение|Описание|
|:-:|:-|
|0...60|Размер структуры|
||Код ошибки|
|0h|модуль прочитан без ошибок|
|1h|модуль прочитан с ошибками|
| |Тип структуры|
|1|модуль|
|2|команда|
| |Информационное поле 1|
|1...18|номер места модуля|
|0...255|Информационное поле 2|
|0...255|Информационное поле 3|
|00h...FFh|Контрольная сумма структуры|
|00h...FFh|Контрольная сумма|
